# Copyright (c) Ultraviolet
# SPDX-License-Identifier: Apache-2.0
[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf

# Read logs directly from Docker JSON files
[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Tag               docker.*
    Refresh_Interval  5
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    DB                /var/log/flb_docker.db

# Parse the log field as JSON
[FILTER]
    Name                parser
    Match               docker.*
    Key_Name            log
    Parser              json
    Reserve_Data        True
    Preserve_Key        True

# Extract container labels for better routing
[FILTER]
    Name                nest
    Match               docker.*
    Operation           lift
    Nested_under        attrs
    Add_prefix          container_

# Enrich with source information and metadata (cluster and environment)
[FILTER]
    Name                  record_modifier
    Match                 docker.*
    Record                source fluent-bit
    Record                log_type application
    Record                cluster cube-cluster
    Record                environment production

# Create separate routing for different log types
[FILTER]
    Name                rewrite_tag
    Match               docker.*
    Rule                $event_type ^(audit_event|llm_request)$ audit.logs false
    Rule                $level ^(error|ERROR|Error)$ error.logs false
    Rule                $level ^(warn|WARN|warning|WARNING|Warning)$ warn.logs false
    Emitter_Name        re_emitted

# Output audit logs to dedicated index
[OUTPUT]
    Name            opensearch
    Match           audit.logs
    Host            opensearch
    Port            9200
    Index           cube-audit-logs
    Type            _doc
    Suppress_Type_Name On
    Retry_Limit     5
    tls             Off
    tls.verify      Off
    Logstash_Format On
    Logstash_Prefix cube-audit
    Logstash_DateFormat %Y.%m.%d

# Output error logs to dedicated index
[OUTPUT]
    Name            opensearch
    Match           error.logs
    Host            opensearch
    Port            9200
    Index           cube-error-logs
    Type            _doc
    Suppress_Type_Name On
    Retry_Limit     5
    tls             Off
    tls.verify      Off
    Logstash_Format On
    Logstash_Prefix cube-error
    Logstash_DateFormat %Y.%m.%d

# Output warning logs to dedicated index
[OUTPUT]
    Name            opensearch
    Match           warn.logs
    Host            opensearch
    Port            9200
    Index           cube-warn-logs
    Type            _doc
    Suppress_Type_Name On
    Retry_Limit     5
    tls             Off
    tls.verify      Off
    Logstash_Format On
    Logstash_Prefix cube-warn
    Logstash_DateFormat %Y.%m.%d

# Output all application logs (catch-all for non-error/non-audit logs)
[OUTPUT]
    Name            opensearch
    Match           docker.*
    Host            opensearch
    Port            9200
    Index           cube-logs
    Type            _doc
    Suppress_Type_Name On
    Retry_Limit     5
    tls             Off
    tls.verify      Off
    Logstash_Format On
    Logstash_Prefix cube-app
    Logstash_DateFormat %Y.%m.%d

# Debug output to stdout
[OUTPUT]
    Name   stdout
    Match  audit.logs
    Format json_lines
