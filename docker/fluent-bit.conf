# Copyright (c) Ultraviolet
# SPDX-License-Identifier: Apache-2.0
[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf

[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Tag               docker.*
    Refresh_Interval  5
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On

# Parse the log field as JSON
[FILTER]
    Name                parser
    Match               docker.*
    Key_Name            log
    Parser              json
    Reserve_Data        True
    Preserve_Key        True

# Extract container labels for better routing
[FILTER]
    Name                nest
    Match               docker.*
    Operation           lift
    Nested_under        attrs
    Add_prefix          container_

# Enrich with source information and metadata (cluster and environment)
[FILTER]
    Name                  record_modifier
    Match                 docker.*
    Record                source fluent-bit
    Record                log_type application
    Record                cluster cube-cluster
    Record                environment production

# Tag audit events specifically
[FILTER]
    Name                grep
    Match               docker.*
    Regex               event_type audit_event|llm_request

# Create separate index for audit events
[FILTER]
    Name                rewrite_tag
    Match               docker.*
    Rule                $event_type ^(audit_event|llm_request)$ audit.logs false
    Rule                $level ^(error|ERROR)$ error.logs false
    Rule                $msg .* application.logs false

# Output audit logs to dedicated index
[OUTPUT]
    Name            opensearch
    Match           audit.logs
    Host            opensearch
    Port            9200
    Index           cube-audit-logs
    Type            _doc
    Suppress_Type_Name On
    Retry_Limit     5
    tls             Off
    tls.verify      Off
    Logstash_Format On
    Logstash_Prefix cube-audit
    Logstash_DateFormat %Y.%m.%d

# Output error logs to dedicated index
[OUTPUT]
    Name            opensearch
    Match           error.logs
    Host            opensearch
    Port            9200
    Index           cube-error-logs
    Type            _doc
    Suppress_Type_Name On
    Retry_Limit     5
    tls             Off
    tls.verify      Off
    Logstash_Format On
    Logstash_Prefix cube-error
    Logstash_DateFormat %Y.%m.%d

# Output all application logs
[OUTPUT]
    Name            opensearch
    Match           application.logs
    Host            opensearch
    Port            9200
    Index           cube-logs
    Type            _doc
    Suppress_Type_Name On
    Retry_Limit     5
    tls             Off
    tls.verify      Off
    Logstash_Format On
    Logstash_Prefix cube-app
    Logstash_DateFormat %Y.%m.%d

# Fallback for unmatched logs
[OUTPUT]
    Name            opensearch
    Match           docker.*
    Host            opensearch
    Port            9200
    Index           cube-logs
    Type            _doc
    Suppress_Type_Name On
    Retry_Limit     5
    tls             Off
    tls.verify      Off

# Debug output to stdout
[OUTPUT]
    Name   stdout
    Match  audit.logs
    Format json_lines
